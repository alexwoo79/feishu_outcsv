---
title: "R_项目工时统计分析笔记"
format: 
  html:
    theme: cosmo
    toc: true
    toc - depth: 3
    code-fold: true
---

# 1. 读取 CSV 文件，处理数据

## 1.1 工时数据获取

编写python程序与飞书api进行交互。获取工时统计收集表数据，并转换生成csv格式文件。


## 1.2 利用R语言导入csv数据文件

```{r}
#| echo: false
#| error: false
#| warning: false
library(tidyverse)
library(viridis)
library(DT)
library(showtext)
library(here)
file_path <- here("output.csv")
df <- read.csv(file_path, sep = ",", fileEncoding = "UTF-8-BOM")

```

# 2. 转换数据处理分析生成报告

```{r}
transfered <- df |>
  filter(is.na(检查) | 检查 == "{}") |>
  mutate(
    p1 = str_c(项目名称.1, as.character(项目工时.1), sep = ":"),
    p2 = str_c(项目名称.2, as.character(项目工时.2), sep = ":"),
    p3 = str_c(项目名称.3, as.character(项目工时.3), sep = ":")
  ) |>
  select(
    -c(项目名称.1, 项目工时.1, 项目名称.2, 项目工时.2, 项目名称.3, 项目工时.3)
  ) |>
  pivot_longer(
    cols = c(p1, p2, p3),
    names_to = "del",
    values_to = "项目工时"
  ) |>
  select(-del) |>
  separate(
    项目工时,
    into = c("项目名称", "项目工时"),
    sep = ":",
    fill = "right",
    extra = "merge"
  ) |>
  mutate(
    项目名称 = str_trim(项目名称),
    项目工时 = as.numeric(项目工时),
    填报日期 = as_datetime(as.numeric(填报日期) / 1000, tz = "UTC") |> as_date()
  ) |>
  filter(!is.na(项目名称), 项目名称 != "{}") |>
  select(-c(检查, record_id, 提交人, 提交时间, 自动编号)) |>
  relocate(填报日期, 姓名)
```

## 2.1 月度-项目工时分析

```{r}
#| warning: false
project_hour <- transfered |>
  mutate(
    Month = as.character(month(填报日期)),
    Quarter = as.character(quarter(填报日期)),
    Year = as.character(year(填报日期))
  ) |>
  group_by(Month, 项目名称) |>
  summarise(总工时 = sum(项目工时, na.rm = TRUE), .groups = "drop")
datatable(project_hour)
```

## 2.2 月度-员工工时分析
```{r}
#| warning: false
user_hour <- transfered |>
  mutate(
    Month = as.character(month(填报日期)),
    Quarter = as.character(quarter(填报日期)),
    Year = as.character(year(填报日期))
  ) |>
  group_by(Month, 姓名) |>
  summarise(总工时 = sum(项目工时, na.rm = TRUE), .groups = "drop")

datatable(user_hour)
```

```{r}
invisible(list(project_hour = project_hour, user_hour = user_hour))
```
## 3.3 项目地坪线图（Ridgeline / 地坪线图）
```{r}
#| warning: false
#| echo: false
# 如果缺少 ggridges 包则自动安装（非破坏性；安装可能需要用户许可/网络）
if (!requireNamespace("ggridges", quietly = TRUE)) {
  install.packages("ggridges")
}
library(ggridges)
library(forcats)
library(viridis)

# 准备数据：确保 Month 为整数并按总工时选取前 N 个项目以便可视化
df_ridge <- project_hour |>
  mutate(Month = as.integer(as.character(Month))) |>
  group_by(项目名称) |>
  summarize(total = sum(总工时, na.rm = TRUE), .groups = "drop") |>
  arrange(desc(total))

top_n <- 20 # 如需更多/更少，可调整
top_projects <- df_ridge$项目名称[seq_len(min(top_n, nrow(df_ridge)))]

df_ridge_plot <- project_hour |>
  mutate(Month = as.integer(as.character(Month))) |>
  filter(项目名称 %in% top_projects) |>
  # 按 precomputed 总工时顺序设置项目因子顺序，避免 fct_reorder 中的 idx 长度错误
  mutate(项目名称 = factor(项目名称, levels = top_projects))

# 使用 ggridges 的 geom_ridgeline 绘制每个项目随月份的工时“地坪”线
p_ridge <- ggplot(
  df_ridge_plot,
  aes(
    x = Month,
    y = 项目名称,
    height = 总工时,
    group = 项目名称,
    fill = 项目名称
  )
) +
  geom_ridgeline(alpha = 0.85, scale = 0.4, colour = "grey30") +
  scale_fill_viridis_d(option = "C", guide = FALSE) +
  scale_x_continuous(breaks = sort(unique(df_ridge_plot$Month))) +
  labs(
    title = "项目按月工时地坪线图",
    x = "Month",
    y = "项目名称"
  ) +
  theme_minimal(base_size = 10) +
  theme(
    axis.text.y = element_text(size = 8),
    plot.title = element_text(face = "bold", size = 12)
  )

p_ridge

invisible(p_ridge)
```

# 3. 分析图表

# 3.1 基于已有 user_hour 对象构造可复用的 ggplot 分析图
```{r}
#| warning: false
# 基于已有 user_hour 对象构造可复用的 ggplot 分析图
user_hour_viz <- (function(df) {
  library(ggplot2)
  library(dplyr)
  library(tidyr)
  library(forcats)
  library(scales)
  library(showtext)
  showtext_auto()

  # 1. 准备数据
  df_prep <- df |>
    mutate(
      Month = as.integer(as.character(Month)), # 确保是整数（若原为字符）
      Month = factor(Month, levels = sort(unique(Month)))
    )

  # 按总工时对姓名排序（总计）
  name_order <- df_prep |>
    group_by(姓名) |>
    summarise(total = sum(总工时, na.rm = TRUE), .groups = "drop") |>
    arrange(desc(total)) |>
    pull(姓名)

  df_prep <- df_prep |>
    mutate(姓名 = factor(姓名, levels = name_order))

  # top users 表（可选）
  top_users <- name_order[seq_len(min(10, length(name_order)))]

  # 2. 图1：分面点图（每月各用户总工时分布）
  p1 <- ggplot(df_prep, aes(x = 姓名, y = 总工时)) +
    geom_col(alpha = 0.8, fill = "#2c7fb8") +
    facet_wrap(~Month, scales = "free_x", ncol = 1) +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
    labs(title = "每月各用户总工时（按月分面）", x = "姓名", y = "总工时")

  # 3. 图2：按月份堆叠条形（每用户每月贡献）—— dodge 版本注释可切换为 position = "stack"
  p2 <- ggplot(df_prep, aes(x = 姓名, y = 总工时, fill = Month)) +
    geom_col(position = position_dodge(width = 0.9), width = 0.8) +
    scale_fill_brewer(palette = "Paired") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
    labs(
      title = "每月用户工时（按月份着色，DODGE）",
      x = "姓名",
      y = "总工时",
      fill = "Month"
    )

  # 4. 图3：热力图 用户 x 月份
  df_tile <- df_prep |>
    complete(姓名, Month, fill = list(总工时 = 0))

  p3 <- ggplot(df_tile, aes(x = Month, y = 姓名, fill = 总工时)) +
    geom_tile(colour = "grey90") +
    scale_fill_viridis_c(option = "magma", labels = comma) +
    theme_minimal() +
    labs(
      title = "用户-月份工时热力图",
      x = "Month",
      y = "姓名",
      fill = "总工时"
    ) +
    theme(axis.text.x = element_text(angle = 0, hjust = 0.5))

  base_font_size <- 6

  my_theme <- theme_minimal(base_size = base_font_size) +
    theme(
      plot.title = element_text(size = base_font_size + 4, face = "bold"),
      axis.title = element_text(size = base_font_size + 2),
      axis.text = element_text(size = base_font_size),
      axis.text.x = element_text(
        angle = 0,
        hjust = 1,
        size = base_font_size - 1
      ),
      legend.title = element_text(size = base_font_size),
      legend.text = element_text(size = base_font_size - 1),
      strip.text = element_text(size = base_font_size), # facet labels
      plot.caption = element_text(size = base_font_size - 2)
    )

  # 将主题加到已创建的 p1 / p2 / p3
  p1 <- p1 + my_theme
  p2 <- p2 + my_theme
  p3 <- p3 + my_theme

  theme_set(my_theme)

  # 返回有用对象，便于后续保存或在交互式会话中显示
  list(
    plots = list(by_month_facet = p1, monthly_dodge = p2, heatmap = p3),
    top_users = top_users,
    data = df_prep
  )
})(user_hour)

user_hour_viz$plots
```

## 3.2 基于 project_hour 构造可复用的 ggplot 分析图

```{r}
#| warning: false
project_hour_viz <- (function(df) {
  library(ggplot2)
  library(dplyr)
  library(tidyr)
  library(forcats)
  library(scales)
  library(viridis)
  library(showtext)
  showtext_auto()
  # 准备数据：确保 Month 为有序因子，按总工时排序项目
  df_prep <- df |>
    mutate(
      Month = as.integer(as.character(Month)),
      Month = factor(Month, levels = sort(unique(Month)))
    )

  project_order <- df_prep |>
    group_by(项目名称) |>
    summarise(total = sum(总工时, na.rm = TRUE), .groups = "drop") |>
    arrange(desc(total)) |>
    pull(项目名称)

  df_prep <- df_prep |>
    mutate(项目名称 = factor(项目名称, levels = project_order))

  top_n <- 10
  top_projects <- project_order[seq_len(min(top_n, length(project_order)))]

  # 图1：横向条形 — 项目总工时（所有月份合计）
  p1_data <- df_prep |>
    group_by(项目名称) |>
    summarise(总工时 = sum(总工时, na.rm = TRUE), .groups = "drop") |>
    arrange(desc(总工时))

  p1 <- ggplot(p1_data, aes(x = fct_reorder(项目名称, 总工时), y = 总工时)) +
    geom_col(fill = "#2b8cbe", width = 0.7) +
    coord_flip() +
    labs(title = "项目总工时排名", x = "项目名称", y = "总工时") +
    theme_minimal()

  # 图2：前 N 项目的月度趋势（折线）
  p2_data <- df_prep |>
    filter(项目名称 %in% top_projects) |>
    group_by(Month, 项目名称) |>
    summarise(总工时 = sum(总工时, na.rm = TRUE), .groups = "drop")

  p2 <- ggplot(
    p2_data,
    aes(x = Month, y = 总工时, color = 项目名称, group = 项目名称)
  ) +
    geom_line(size = 1) +
    geom_point(size = 2) +
    labs(
      title = paste0("前 ", length(top_projects), " 项目月度工时趋势"),
      x = "Month",
      y = "总工时",
      color = "项目"
    ) +
    theme_minimal() +
    theme(legend.position = "right")

  # 图3：项目 x 月份 热力图（按项目排序）
  df_tile <- df_prep |>
    complete(项目名称, Month, fill = list(总工时 = 0))

  p3 <- ggplot(df_tile, aes(x = Month, y = 项目名称, fill = 总工时)) +
    geom_tile(colour = "grey90") +
    scale_fill_viridis_c(option = "magma", labels = comma) +
    labs(
      title = "项目-月份工时热力图",
      x = "Month",
      y = "项目名称",
      fill = "总工时"
    ) +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 0, hjust = 0.5))

  # 统一主题（可调整 base_font_size）
  base_font_size <- 5
  my_theme <- theme_minimal(base_size = base_font_size) +
    theme(
      plot.title = element_text(size = base_font_size + 4, face = "bold"),
      axis.title = element_text(size = base_font_size + 2),
      axis.text = element_text(size = base_font_size),
      legend.title = element_text(size = base_font_size),
      legend.text = element_text(size = base_font_size - 1),
      strip.text = element_text(size = base_font_size)
    )

  p1 <- p1 + my_theme
  p2 <- p2 + my_theme
  p3 <- p3 + my_theme

  list(
    plots = list(rank_bar = p1, top_trends = p2, heatmap = p3),
    top_projects = top_projects,
    data = df_prep
  )
})(project_hour)

project_hour_viz$plots
```